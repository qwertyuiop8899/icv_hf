<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICV Custom Formatter</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a28;
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #ec4899);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .panel-content {
            padding: 1rem;
        }

        .preset-selector {
            margin-bottom: 1rem;
        }

        .preset-selector label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .preset-selector select {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .template-field {
            margin-bottom: 1rem;
        }

        .template-field label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .template-field textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            resize: vertical;
            min-height: 80px;
        }

        .template-field textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .preview-container {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .preview-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 0.4rem;
        }

        .stremio-card {
            background: linear-gradient(180deg, #1a1a2e 0%, #16162a 100%);
            border-radius: 6px;
            padding: 0.75rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .stremio-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.4rem;
        }

        .stremio-description {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
            white-space: pre-line;
        }

        .button-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #ec4899);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .variables-ref {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .var-item {
            background: var(--bg-tertiary);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.65rem;
            color: var(--accent);
            cursor: pointer;
        }

        .var-item:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .section-title {
            color: var(--text-muted);
            font-size: 0.7rem;
            margin: 0.75rem 0 0.4rem;
            text-transform: uppercase;
        }

        .current-selection {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: var(--success);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üé® ICV Custom Formatter</h1>
        </header>

        <div id="currentSelection" class="current-selection" style="display: none;">
            ‚úì Preset attuale: <span id="currentPresetName">-</span>
        </div>

        <div class="main-grid">
            <!-- Left: Editor -->
            <div class="panel">
                <div class="panel-header">üìù Template Editor</div>
                <div class="panel-content">
                    <div class="preset-selector">
                        <label>Preset</label>
                        <select id="presetSelect">
                            <optgroup label="üì¶ Preset Base">
                                <option value="default">Default ICV</option>
                                <option value="torrentio">Torrentio Style</option>
                                <option value="minimal">Minimal</option>
                                <option value="verbose">Verbose</option>
                                <option value="italiano">Italiano Completo</option>
                            </optgroup>
                            <optgroup label="üë• Community">
                                <option value="fra">Fra Style</option>
                                <option value="dav">Dav Style (4K labels)</option>
                                <option value="and">And Style (Decorativo)</option>
                                <option value="lad">Lad Style (Clean)</option>
                                <option value="pri">Pri Style (Premium)</option>
                            </optgroup>
                            <option value="custom">üìù Custom</option>
                        </select>
                    </div>

                    <div class="template-field">
                        <label>Template Nome</label>
                        <textarea id="nameTemplate" rows="2"></textarea>
                    </div>

                    <div class="template-field">
                        <label>Template Descrizione</label>
                        <textarea id="descriptionTemplate" rows="5"></textarea>
                    </div>

                    <div class="preview-container">
                        <div class="preview-label">Anteprima</div>
                        <div class="stremio-card">
                            <div class="stremio-name" id="previewName">-</div>
                            <div class="stremio-description" id="previewDescription">-</div>
                        </div>
                    </div>

                    <div class="button-row">
                        <button class="btn btn-primary" id="saveBtn">üíæ Salva e Chiudi</button>
                        <button class="btn btn-secondary" id="cancelBtn">Annulla</button>
                    </div>
                </div>
            </div>

            <!-- Right: Variables -->
            <div class="panel">
                <div class="panel-header">üìö Variabili</div>
                <div class="panel-content">
                    <div class="section-title">Stream</div>
                    <div class="variables-ref">
                        <div class="var-item" onclick="insertVar('{stream.title}')">{stream.title}</div>
                        <div class="var-item" onclick="insertVar('{stream.filename}')">{stream.filename}</div>
                        <div class="var-item" onclick="insertVar('{stream.size::bytes}')">{stream.size::bytes}</div>
                        <div class="var-item" onclick="insertVar('{stream.packSize::bytes}')">{stream.packSize::bytes}
                        </div>
                        <div class="var-item" onclick="insertVar('{stream.quality}')">{stream.quality}</div>
                        <div class="var-item" onclick="insertVar('{stream.codec}')">{stream.codec}</div>
                        <div class="var-item" onclick="insertVar('{stream.seeders}')">{stream.seeders}</div>
                        <div class="var-item" onclick="insertVar('{stream.languages::join(\' | \')}')">
                            {stream.languages}</div>
                        <div class="var-item" onclick="insertVar('{stream.languageEmojis::join(\' \')}')">
                            {stream.languageEmojis}</div>
                        <div class="var-item" onclick="insertVar('{stream.releaseGroup}')">{stream.releaseGroup}</div>
                        <div class="var-item" onclick="insertVar('{stream.visualTags::join(\' \')}')">
                            {stream.visualTags}</div>
                        <div class="var-item" onclick="insertVar('{stream.audioTags::join(\' \')}')">{stream.audioTags}
                        </div>
                        <div class="var-item" onclick="insertVar('{stream.season}')">{stream.season}</div>
                        <div class="var-item" onclick="insertVar('{stream.episode}')">{stream.episode}</div>
                    </div>

                    <div class="section-title">Service</div>
                    <div class="variables-ref">
                        <div class="var-item" onclick="insertVar('{service.shortName}')">{service.shortName}</div>
                        <div class="var-item" onclick="insertVar('{service.name}')">{service.name}</div>
                        <div class="var-item" onclick="insertVar('{service.cached}')">
                            {service.cached}</div>
                    </div>

                    <div class="section-title">Addon</div>
                    <div class="variables-ref">
                        <div class="var-item" onclick="insertVar('{addon.name}')">{addon.name}</div>
                    </div>

                    <div class="section-title">Sintassi</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); line-height: 1.6;">
                        <code>::bytes</code> ‚Üí Formatta bytes<br>
                        <code>::upper/lower</code> ‚Üí Maiuscolo/minuscolo<br>
                        <code>::join(' ')</code> ‚Üí Unisci array<br>
                        <code>::exists["se"||"no"]</code> ‚Üí Condizione<br>
                        <code>::istrue["‚ö°"||"‚è≥"]</code> ‚Üí Boolean<br>
                        <code>::=1080p["FHD"||""]</code> ‚Üí Comparazione
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data per preview - Complete AIOStreams fields
        const mockData = {
            stream: {
                // Basic info
                title: "Il Trono Di Spade",
                filename: "Il.Trono.Di.Spade.S01E03.1080p.BluRay.HEVC.DTS-HD.MA.ITA.ENG-BlackBit.mkv",
                folderName: "Il.Trono.Di.Spade.S01.Complete.1080p.BluRay",
                size: 1624273183,
                folderSize: 15064597791,
                packSize: 15064597791,
                library: false,

                // Quality info (AIOStreams fields)
                quality: "BluRay",
                resolution: "1080p",
                encode: "HEVC",
                codec: "HEVC",

                // Languages
                languages: ["Italian", "English"],
                uLanguages: ["Italian"],
                languageEmojis: ["üáÆüáπ", "üá¨üáß"],
                uLanguageEmojis: ["üáÆüáπ"],
                languageCodes: ["IT", "EN"],
                uLanguageCodes: ["IT"],
                smallLanguageCodes: ["…™·¥õ", "·¥á…¥"],

                // Tags
                visualTags: ["HDR", "10bit"],
                audioTags: ["DTS-HD MA", "5.1"],
                audioChannels: ["5.1"],
                releaseGroup: "BlackBit",

                // Episode info
                year: "2011",
                seasons: [1],
                season: 1,
                formattedSeasons: "S01",
                episodes: [3],
                episode: 3,
                formattedEpisodes: "E03",
                seasonEpisode: ["S01", "E03"],
                seasonPack: true,

                // Metadata
                regexMatched: null,
                edition: null,
                remastered: false,
                repack: false,
                uncensored: false,
                unrated: false,
                upscaled: false,
                network: null,
                container: "mkv",
                extension: "mkv",

                // Torrent info
                seeders: 26,
                private: false,
                age: "2y",
                ageHours: 17520,
                duration: 3540,
                infoHash: "abc123def456",

                // Stream type
                type: "Debrid",
                message: null,
                proxied: false,
                seadex: false,
                seadexBest: false,

                // ICV specific
                source: "BluRay",
                audio: "DTS-HD MA",
                cached: true,
                isPack: true,
                indexer: "Knaben"
            },
            config: {
                addonName: "IlCorsaroViola"
            },
            service: {
                id: "realdebrid",
                name: "Real-Debrid",
                shortName: "RD",
                cached: true
            },
            addon: {
                name: "IlCorsaroViola",
                version: "3.0.0",
                presetId: "pri",
                manifestUrl: null
            },
            tools: {
                newLine: "\n",
                removeLine: ""
            }
        };

        // Preset templates
        const PRESETS = {
            default: {
                name: `{service.shortName::exists["[{service.shortName}] "||""]}üì∫ {stream.title}`,
                description: `{stream.quality} | üíæ {stream.size::bytes} | üë§ {stream.seeders} seeders`
            },
            torrentio: {
                name: `{service.shortName::exists["[{service.shortName}"||""]}{service.cached::istrue["+]"||"]"]} ICV {stream.quality}`,
                description: `{stream.filename}\nüíæ {stream.size::bytes} {stream.packSize::>0["/ üì¶ {stream.packSize::bytes}"||""]} üë§ {stream.seeders}\n{stream.languageEmojis::join(' ')}`
            },
            minimal: {
                name: `{stream.quality} {stream.codec}`,
                description: `{stream.size::bytes} ‚Ä¢ {stream.seeders} seeds`
            },
            verbose: {
                name: `{service.cached::istrue["‚ö°"||"‚è≥"]} [{service.shortName}] {stream.quality} {stream.codec}`,
                description: `üìÅ {stream.filename}\nüíæ Ep: {stream.size::bytes}{stream.packSize::>0[" / Pack: {stream.packSize::bytes}"||""]}\nüë§ {stream.seeders} ‚Ä¢ üé¨ {stream.source} ‚Ä¢ üîä {stream.audio}\nüåç {stream.languages::join(' | ')}`
            },
            italiano: {
                name: `{service.cached::istrue["‚ö°"||"‚è≥"]} {service.shortName::exists["[{service.shortName}]"||""]} {stream.quality} {stream.codec}`,
                description: `üì∫ {stream.title}\nüìÅ {stream.filename}\nüíæ {stream.size::bytes}{stream.isPack::istrue[" (Pack: {stream.packSize::bytes})"||""]}\nüåç {stream.languageEmojis::join(' ')} | üë§ {stream.seeders} | ‚è∞ {stream.age}\nüé¨ {stream.source} | üîä {stream.audio} | üè∑Ô∏è {stream.releaseGroup::exists["{stream.releaseGroup}"||"N/A"]}`
            },
            fra: {
                name: `{service.cached::istrue["‚ö°Ô∏è"||"‚è≥"]} {addon.name} {stream.quality::=1080p["FHD"||""]}{stream.quality::=720p["HD"||""]}{stream.quality::=2160p["4K"||""]}{stream.quality::exists[""||"UNK"]}`,
                description: `üìÑ ‚ùØ {stream.filename}\n{stream.languages::exists["üåé ‚ùØ {stream.languages::join(' ‚Ä¢ ')}"||""]}\n‚ú® ‚ùØ {service.shortName::exists["{service.shortName}"||""]}{stream.releaseGroup::exists[" ‚Ä¢ {stream.releaseGroup}"||""]}\n{stream.quality::exists["üî• ‚ùØ {stream.quality}"||""]}{stream.visualTags::exists[" ‚Ä¢ {stream.visualTags::join(' ‚Ä¢ ')}"||""]}\n{stream.size::>0["üíæ ‚ùØ {stream.size::bytes}"||""]}{service.cached::isfalse[" / üë• ‚ùØ {stream.seeders}"||""]}`
            },
            dav: {
                name: `{stream.resolution::~2160::or::stream.resolution::~4k::or::stream.resolution::~uhd["üî•4K UHD"||""]}{stream.resolution::~1080::or::stream.resolution::~fhd["üöÄ FHD"||""]}{stream.resolution::~720::or::stream.resolution::~hd["üíø HD"||""]}{stream.resolution::exists::isfalse["üí© Unknown"||""]}`,
                description: `{stream.quality::exists["üé• {stream.quality} "||""]}{stream.visualTags::exists["üì∫ {stream.visualTags::join(' | ')} "||""]}{stream.codec::exists["üéûÔ∏è {stream.codec} "||""]}\n{stream.audioTags::exists["üéß {stream.audioTags::join(' | ')} "||""]}{stream.languageEmojis::exists["üó£Ô∏è {stream.languageEmojis::join(' / ')}"||""]}\n{stream.size::>0["üì¶ {stream.size::bytes} "||""]}{stream.seeders::>0["üë• {stream.seeders} "||""]}{stream.releaseGroup::exists["üè∑Ô∏è {stream.releaseGroup} "||""]}\n{service.cached::istrue["‚ö°"||"‚è≥"]}{service.shortName::exists["{service.shortName} "||""]}üîç{addon.name}\nüìÑ {stream.filename}`
            },
            and: {
                name: `{stream.title::exists["üé¨ {stream.title}"||""]} S{stream.season}E{stream.episode}`,
                description: `{stream.quality} {service.cached::istrue["/‚ö°"||"/‚è≥"]}\n‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ\n{stream.languageEmojis::exists["Lingue: {stream.languageEmojis::join(' | ')}"||""]}\nSpecifiche: {stream.quality}{stream.visualTags::exists[" | üì∫ {stream.visualTags::join(' ')}"||""]}{stream.audioTags::exists[" | üîä {stream.audioTags::join(', ')}"||""]}\n‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ\nüìÇ {stream.size::>0["{stream.size::bytes}"||""]}{service.name::exists[" | ‚òÅÔ∏è {service.name}"||""]}{addon.name::exists[" | üõ∞Ô∏è {addon.name}"||""]}`
            },
            lad: {
                name: `{stream.resolution::~2160::or::stream.resolution::~4k::or::stream.resolution::~uhd["üñ•Ô∏è 4K"||""]}{stream.resolution::~1080::or::stream.resolution::~fhd["üñ•Ô∏è 1080p"||""]}{stream.resolution::~720::or::stream.resolution::~hd["üñ•Ô∏è 720p"||""]}{stream.resolution::exists::isfalse["üñ•Ô∏è Unknown"||""]}`,
                description: `{stream.title::exists["üéüÔ∏è {stream.title}"||""]}\nüìú S{stream.season}E{stream.episode}\n{stream.quality::exists["üé• {stream.quality} "||""]}{stream.codec::exists["üéûÔ∏è {stream.codec} "||""]}{stream.audioTags::exists["üéß {stream.audioTags::join(' | ')}"||""]}\n{stream.size::>0["üì¶ {stream.size::bytes}"||""]}\nüîó {addon.name}\n{stream.languageEmojis::exists["üåê {stream.languageEmojis::join(' ')}"||""]}`
            },
            pri: {
                name: `{service.shortName::exists["[{service.shortName}"||""]}{service.cached::istrue["‚ö°Ô∏è"||"‚ùåÔ∏è"]}{service.shortName::exists["‚òÅÔ∏è]"||""]}\n{stream.resolution::~2160::or::stream.resolution::~4k::or::stream.resolution::~uhd["4Küî•UHD"||""]}{stream.resolution::~1440::or::stream.resolution::~2k::or::stream.resolution::~qhd["2K‚ú®QHD"||""]}{stream.resolution::~1080::or::stream.resolution::~fhd["FHDüöÄ1080p"||""]}{stream.resolution::~720::or::stream.resolution::~hd["HDüíø720p"||""]}{stream.resolution::~480::or::stream.resolution::~sd["SDüì∫"||""]}{stream.resolution::exists::isfalse["Unknownüí©"||""]}\n[{addon.name}]`,
                description: `üé¨ {stream.title::title} {stream.year::exists["({stream.year}) "||""]}{stream.formattedSeasons::exists["{stream.formattedSeasons}"||""]}{stream.formattedEpisodes::exists["{stream.formattedEpisodes}"||""]}\n{stream.quality::~Remux["üíé  Ä·¥á·¥ç·¥úx"||""]}{stream.quality::~BluRay["üìÄ  ô ü·¥ú Ä·¥Ä è"||""]}{stream.quality::~WEB-DL["üñ• ·¥°·¥á ô-·¥Ö ü"||""]}{stream.quality::~WEBRip["üíª ·¥°·¥á ô Ä…™·¥ò"||""]}{stream.quality::~HDTV["üì∫  ú·¥Ö·¥õ·¥†"||""]}{stream.encode::exists[" | üéûÔ∏è {stream.encode::small}"||""]}{stream.visualTags::exists[" | üîÜ {stream.visualTags::join(' | ')}"||""]}\n{stream.audioTags::exists["üéß {stream.audioTags::join(' | ')}"||""]}{stream.audioChannels::exists[" | üîä{stream.audioChannels::first}"||""]}{stream.languageEmojis::exists[" | üó£Ô∏è {stream.languageEmojis::join(' / ')}"||""]}\n{stream.size::>0["üìÅ {stream.size::bytes}"||""]}{stream.releaseGroup::exists["  | üè∑Ô∏è {stream.releaseGroup}"||""]}{stream.duration::>0[" | ‚è±Ô∏è {stream.duration::time}"||""]}\nüìÑ ‚ñ∂Ô∏è{stream.filename::replace('.',' ')::small}‚óÄÔ∏è`
            },
            custom: { name: '', description: '' }
        };

        // Parser functions (same as formatter.cjs)
        function formatBytes(bytes, base = 1000, round = false) {
            if (!bytes || bytes === 0) return '0 B';
            const sizes = base === 1024 ? ['B', 'KiB', 'MiB', 'GiB', 'TiB'] : ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(base));
            const val = bytes / Math.pow(base, i);
            return (round ? Math.round(val) : val.toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            if (!seconds || seconds <= 0) return '0:00';
            seconds = Math.floor(seconds);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Small caps mapping (from AIOStreams) - Uses mathematical monospace digits
        const SMALL_CAPS_MAP = {
            A: '·¥Ä', B: ' ô', C: '·¥Ñ', D: '·¥Ö', E: '·¥á', F: 'Íú∞', G: '…¢', H: ' ú', I: '…™',
            J: '·¥ä', K: '·¥ã', L: ' ü', M: '·¥ç', N: '…¥', O: '·¥è', P: '·¥ò', Q: '«´', R: ' Ä',
            S: 'Íú±', T: '·¥õ', U: '·¥ú', V: '·¥†', W: '·¥°', X: 'ùòÖ', Y: ' è', Z: '·¥¢',
            '0': 'ùü¢', '1': 'ùü£', '2': 'ùü§', '3': 'ùü•', '4': 'ùü¶',
            '5': 'ùüß', '6': 'ùü®', '7': 'ùü©', '8': 'ùü™', '9': 'ùü´'
        };
        const makeSmall = (str) => String(str).split('').map(c => SMALL_CAPS_MAP[c.toUpperCase()] || c).join('');

        // String modifiers
        const stringModifiers = {
            upper: v => String(v).toUpperCase(),
            lower: v => String(v).toLowerCase(),
            title: v => String(v).split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' '),
            small: v => makeSmall(v),
            length: v => String(v).length.toString(),
            reverse: v => String(v).split('').reverse().join(''),
            string: v => String(v),
        };

        // Array modifiers
        const arrayModifiers = {
            join: v => Array.isArray(v) ? v.join(', ') : v,
            length: v => Array.isArray(v) ? v.length.toString() : '0',
            first: v => Array.isArray(v) && v.length > 0 ? String(v[0]) : '',
            last: v => Array.isArray(v) && v.length > 0 ? String(v[v.length - 1]) : '',
            reverse: v => Array.isArray(v) ? [...v].reverse() : v,
        };

        // Number modifiers
        const numberModifiers = {
            bytes: v => formatBytes(Number(v), 1000, false),
            rbytes: v => formatBytes(Number(v), 1000, true),
            bytes2: v => formatBytes(Number(v), 1024, false),
            time: v => formatDuration(Number(v)),
            hex: v => Number(v).toString(16),
            string: v => String(v),
        };

        // Conditional modifiers
        const conditionalModifiers = {
            exact: {
                istrue: v => v === true,
                isfalse: v => v === false,
                exists: v => v !== null && v !== undefined && v !== '' && !(Array.isArray(v) && v.length === 0),
            },
            prefix: {
                '$': (v, c) => String(v).toLowerCase().startsWith(c.toLowerCase()),
                '^': (v, c) => String(v).toLowerCase().endsWith(c.toLowerCase()),
                '~': (v, c) => String(v).toLowerCase().includes(c.toLowerCase()),
                '=': (v, c) => String(v).toLowerCase() === c.toLowerCase(),
                '>=': (v, c) => Number(v) >= Number(c),
                '>': (v, c) => Number(v) > Number(c),
                '<=': (v, c) => Number(v) <= Number(c),
                '<': (v, c) => Number(v) < Number(c),
            },
        };

        // Comparator functions
        const comparatorFuncs = {
            and: (v1, v2) => v1 && v2,
            or: (v1, v2) => v1 || v2,
            xor: (v1, v2) => (v1 || v2) && !(v1 && v2),
        };

        function getNestedValue(data, path) {
            if (!path) return undefined;
            const [ns, prop] = path.split('.');
            if (!ns || !prop) return undefined;
            const section = data[ns];
            if (!section || typeof section !== 'object') return undefined;
            return section[prop];
        }

        function applySingleModifier(value, mod, originalMod) {
            if (value === undefined || value === null) return undefined;
            const modLower = mod.toLowerCase();

            // Conditional modifiers
            const isExact = Object.keys(conditionalModifiers.exact).includes(modLower);
            const prefixMatch = Object.keys(conditionalModifiers.prefix).sort((a, b) => b.length - a.length).find(k => modLower.startsWith(k));

            if (isExact) {
                if (!conditionalModifiers.exact.exists(value)) return false;
                return conditionalModifiers.exact[modLower](value);
            }

            if (prefixMatch) {
                if (!conditionalModifiers.exact.exists(value)) return false;
                const checkValue = mod.substring(prefixMatch.length);
                const stringValue = String(value).toLowerCase();
                let stringCheck = checkValue.toLowerCase().replace(/\s/g, '');
                if (['<', '<=', '>', '>=', '='].includes(prefixMatch)) {
                    const numValue = Number(String(value).replace(/,/g, ''));
                    const numCheck = Number(stringCheck.replace(/,/g, ''));
                    if (!isNaN(numValue) && !isNaN(numCheck)) {
                        return conditionalModifiers.prefix[prefixMatch](numValue, numCheck);
                    }
                }
                return conditionalModifiers.prefix[prefixMatch](stringValue, stringCheck);
            }

            // String modifiers
            if (typeof value === 'string') {
                if (modLower in stringModifiers) return stringModifiers[modLower](value);
                // replace('find', 'replace')
                if (modLower.startsWith('replace(') && modLower.endsWith(')')) {
                    const content = originalMod.substring(8, originalMod.length - 1);
                    const q = content.charAt(0);
                    const parts = content.split(new RegExp(`${q}\\s*,\\s*${q}`));
                    if (parts.length === 2) {
                        const find = parts[0].substring(1);
                        const repl = parts[1].substring(0, parts[1].length - 1);
                        return value.split(find).join(repl);
                    }
                }
                // truncate(N)
                if (modLower.startsWith('truncate(') && modLower.endsWith(')')) {
                    const n = parseInt(originalMod.substring(9, originalMod.length - 1));
                    if (!isNaN(n) && n >= 0) return value.length > n ? value.slice(0, n) + '‚Ä¶' : value;
                }
            }

            // Array modifiers
            if (Array.isArray(value)) {
                if (modLower in arrayModifiers) return arrayModifiers[modLower](value);
                if (modLower.startsWith('join(') && modLower.endsWith(')')) {
                    const sep = originalMod.substring(6, originalMod.length - 2);
                    return value.join(sep);
                }
            }

            // Number modifiers
            if (typeof value === 'number') {
                if (modLower in numberModifiers) return numberModifiers[modLower](value);
            }

            return undefined;
        }

        function parseTemplate(template, data, maxDepth = 15) {
            if (!template || maxDepth <= 0) return template || '';
            template = template.replace(/\{tools\.newLine\}/g, '\n');
            let result = template, lastResult = null, iterations = 0;

            while (result !== lastResult && iterations < maxDepth) {
                lastResult = result; iterations++;
                const regex = /\{([a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z_][a-zA-Z0-9_]*)([^[\]{}]*?)(?:\["([^"]*)"\|\|"([^"]*)"\])?\}/g;
                let match;
                const replacements = [];
                while ((match = regex.exec(result)) !== null) {
                    const fullMatch = match[0], varPath = match[1], modStr = match[2] || '', trueVal = match[3], falseVal = match[4];
                    const replacement = resolveVariable(varPath, modStr, trueVal, falseVal, data, maxDepth - 1);
                    replacements.push({ fullMatch, replacement, index: match.index });
                }
                for (let i = replacements.length - 1; i >= 0; i--) {
                    const { fullMatch, replacement, index } = replacements[i];
                    result = result.slice(0, index) + replacement + result.slice(index + fullMatch.length);
                }
            }
            return result.split('\n').filter(l => l.trim() !== '' && !l.includes('{tools.removeLine}')).join('\n').replace(/\n\s*\n\s*\n/g, '\n\n').trim();
        }

        function resolveVariable(varPath, modStr, trueVal, falseVal, data, maxDepth) {
            const comparatorRegex = /::(and|or|xor)::/gi;
            const segments = modStr.split(comparatorRegex).filter(s => s);
            const varExprs = [], comparators = [];

            for (let i = 0; i < segments.length; i++) {
                const seg = segments[i].toLowerCase();
                if (Object.keys(comparatorFuncs).includes(seg)) comparators.push(seg);
                else varExprs.push(segments[i]);
            }
            if (varExprs.length === 0) varExprs.push('');

            const resolvedValues = varExprs.map((expr, idx) => {
                let curPath = varPath, mods = expr;
                if (idx > 0 && expr.match(/^[a-zA-Z_]+\.[a-zA-Z_]+/)) {
                    const pm = expr.match(/^([a-zA-Z_]+\.[a-zA-Z_]+)(.*)/);
                    if (pm) { curPath = pm[1]; mods = pm[2]; }
                }
                let value = getNestedValue(data, curPath);
                const modList = mods.split('::').filter(m => m);
                for (const mod of modList) {
                    const newVal = applySingleModifier(value, mod, mod);
                    if (newVal === undefined) { if (typeof value === 'boolean') return value; return undefined; }
                    value = newVal;
                }
                return value;
            });

            let finalResult = resolvedValues[0];
            for (let i = 0; i < comparators.length; i++) {
                const cmp = comparators[i], nxt = resolvedValues[i + 1];
                if (comparatorFuncs[cmp]) finalResult = comparatorFuncs[cmp](finalResult, nxt);
            }

            if (trueVal !== undefined) {
                const output = Boolean(finalResult) ? trueVal : (falseVal || '');
                return parseTemplate(output, data, maxDepth);
            }
            if (Array.isArray(finalResult)) return finalResult.join(', ');
            return finalResult ?? '';
        }

        // UI Elements
        const presetSelect = document.getElementById('presetSelect');
        const nameTemplate = document.getElementById('nameTemplate');
        const descriptionTemplate = document.getElementById('descriptionTemplate');
        const previewName = document.getElementById('previewName');
        const previewDescription = document.getElementById('previewDescription');
        const currentSelection = document.getElementById('currentSelection');
        const currentPresetName = document.getElementById('currentPresetName');

        let selectedPreset = 'default';

        function updatePreview() {
            try {
                previewName.textContent = parseTemplate(nameTemplate.value, mockData) || '(vuoto)';
                previewDescription.textContent = parseTemplate(descriptionTemplate.value, mockData) || '(vuoto)';
            } catch (e) {
                previewName.textContent = 'Errore: ' + e.message;
            }
        }

        function loadPreset(presetId) {
            if (presetId === 'custom') return;
            const preset = PRESETS[presetId];
            if (preset) {
                nameTemplate.value = preset.name;
                descriptionTemplate.value = preset.description;
                selectedPreset = presetId;
                updatePreview();
            }
        }

        function insertVar(variable) {
            const active = document.activeElement;
            if (active === nameTemplate || active === descriptionTemplate) {
                const start = active.selectionStart;
                active.value = active.value.substring(0, start) + variable + active.value.substring(active.selectionEnd);
                active.selectionStart = active.selectionEnd = start + variable.length;
                active.focus();
            } else {
                descriptionTemplate.value += variable;
            }
            presetSelect.value = 'custom';
            selectedPreset = 'custom';
            updatePreview();
        }

        // Event listeners
        presetSelect.addEventListener('change', e => loadPreset(e.target.value));
        nameTemplate.addEventListener('input', () => { presetSelect.value = 'custom'; selectedPreset = 'custom'; updatePreview(); });
        descriptionTemplate.addEventListener('input', () => { presetSelect.value = 'custom'; selectedPreset = 'custom'; updatePreview(); });

        // Save button
        document.getElementById('saveBtn').addEventListener('click', () => {
            const config = {
                preset: selectedPreset,
                customName: selectedPreset === 'custom' ? nameTemplate.value : null,
                customDesc: selectedPreset === 'custom' ? descriptionTemplate.value : null
            };

            if (window.opener) {
                window.opener.postMessage({ type: 'formatter-config', config }, '*');
                window.close();
            } else {
                // Standalone mode - show config
                alert('Config: ' + JSON.stringify(config, null, 2));
            }
        });

        // Cancel button
        document.getElementById('cancelBtn').addEventListener('click', () => {
            if (window.opener) window.close();
        });

        // Load initial config from URL or opener
        function init() {
            // Check if config passed in URL
            const urlParams = new URLSearchParams(window.location.search);
            const preset = urlParams.get('preset') || 'default';
            const customName = decodeURIComponent(urlParams.get('name') || '');
            const customDesc = decodeURIComponent(urlParams.get('desc') || '');

            // If we have a custom config, load it
            if (preset === 'custom' && (customName || customDesc)) {
                presetSelect.value = 'custom';
                nameTemplate.value = customName;
                descriptionTemplate.value = customDesc;
                selectedPreset = 'custom';
                currentSelection.style.display = 'block';
                currentPresetName.textContent = 'Custom (salvato)';
                updatePreview();
            } else if (preset && PRESETS[preset]) {
                presetSelect.value = preset;
                loadPreset(preset);
                currentSelection.style.display = 'block';
                currentPresetName.textContent = preset.charAt(0).toUpperCase() + preset.slice(1);
            } else {
                loadPreset('default');
            }
        }

        init();
    </script>
</body>

</html>
